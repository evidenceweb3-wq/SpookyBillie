<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Billy Fall Switcher + Mask + Color Mask + Leaves + Dual Scenes + Hats</title>
<style>
body {
  background: #111;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  margin: 0;
  font-family: sans-serif;
  height: 100vh;
}

#container {
  position: relative;
  width: 90vmin;
  height: 90vmin;
  max-width: 90vw;
  max-height: 90vw;
  background: #fff;
  border-radius: 10px;
  overflow: hidden;
  margin-top: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}

canvas {
  width: 100%;
  height: 100%;
  border-radius: 10px;
  display: block;
}

.containerButtons {
  position: absolute;
  bottom: 10px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 8px;
}

.containerButtons button {
  padding: 6px 12px;
  border-radius: 6px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  background: white;
  box-shadow: 0 0 6px rgba(0,0,0,0.3);
}

.controls, .secondaryControls {
  margin-top: 10px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  width: 90vmin;
  max-width: 90vw;
}

.controls button, .secondaryControls button {
  flex: 1 1 30%;
  padding: 8px 0;
  border-radius: 6px;
  border: none;
  font-weight: bold;
  cursor: pointer;
  background: white;
  color: black;
  transition: all 0.2s ease;
}

/* MOBILE FIX */
@media(max-width:600px){
  #container {
    width: 90vmin;
    height: 90vmin;
    max-width: 95vw;
    max-height: 95vw;
    margin-top: 5px;
  }

  .controls, .secondaryControls {
    width: 95vw;
    flex-direction: column;
    gap: 6px;
  }

  .controls button, .secondaryControls button {
    flex: 1 1 100%;
    width: 100%;
  }

  .containerButtons {
    flex-direction: column;
    gap: 6px;
  }
}
</style>
</head>
<body>

<div id="container">
  <canvas id="canvas"></canvas>
  <div class="containerButtons">
    <button id="randomBtn">üé≤ Random</button>
    <button id="leavesBtn">üçÇ Leaves</button>
  </div>
</div>

<div class="controls">
  <button id="bgButton">Background</button>
  <input type="color" id="bgColor" value="#ffffff" style="display:none;">
  <button id="colorMaskButton">Billie Color</button>
  <input type="color" id="colorMask" value="#ffcc99" style="display:none;">
  <button id="sceneBtn">üé¨ Scene</button>
  <button id="save">Save PNG</button>
</div>

<div class="secondaryControls">
  <button id="hornBtn">Horns</button>
  <button id="hatBtn">Hats</button>
  <button id="glassesBtn">Glasses</button>
</div>

<script>
// ==== CANVAS SETUP ====
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

// HORNS
const hornSources = [
  "https://i.postimg.cc/KYTmT02j/BillyFallBase3.png",
  "https://i.postimg.cc/fLKn7Fq6/Horn2.png"
];
const horns = [];
let currentHorn = 0;
hornSources.forEach(src => { const img = new Image(); img.crossOrigin="anonymous"; img.src=src; horns.push(img); });

// MASKS
const maskSources = [
  null,
  "https://i.postimg.cc/5NWYLjj2/Mask-Pumpking3.png",
  "https://i.postimg.cc/gJDLjj0H/Glasses1.png",
  "https://i.postimg.cc/ry1nS0gY/Skull-Glasses2.png",
  "https://i.postimg.cc/0yKP50d0/Ba-Tglasses.png",
  "https://i.postimg.cc/SsTT1FSb/Skeletes2.png",
  "https://i.postimg.cc/j5n4jXCh/SUnglasses-SK-l.png",
  "https://i.postimg.cc/ZqbygLrd/lentes5.png",
  "https://i.postimg.cc/W4dkmwgz/Glass-Blood.png",
  "https://i.postimg.cc/8cj9N36k/Glass-Cnagel.png"
];
const masks = [];
let currentMask = 0;
maskSources.forEach(src => { if(src){ const img=new Image(); img.crossOrigin="anonymous"; img.src=src; masks.push(img);} else masks.push(null); });

// HATS
const hatSources = [null,"https://i.postimg.cc/636Tj5xG/Hattes2sombras.png","https://i.postimg.cc/yN3z7Mh5/Hateer23.png"];
const hats = [];
let currentHat = 0;
hatSources.forEach(src => { if(src){ const img=new Image(); img.crossOrigin="anonymous"; img.src=src; hats.push(img);} else hats.push(null); });

// COLOR MASK
const colorMaskSrc = "https://i.postimg.cc/0NzkgQgy/Mask40.png";
const colorMask = new Image();
colorMask.crossOrigin = "anonymous";
colorMask.src = colorMaskSrc;
let colorMaskColor = null;

// STATIC LEAVES
const bgLeaves = new Image();
bgLeaves.crossOrigin = "anonymous";
bgLeaves.src = "https://i.postimg.cc/2jqF2p04/Leaves22.png";

// SCENES
const sceneSources = [
  "https://i.postimg.cc/132fCVjd/Chat-GPT-Image-8-oct-2025-16-45-48.png",
  "https://i.postimg.cc/XNTpMmZg/Noche2.png"
];
const sceneImgs = sceneSources.map(src => { const img = new Image(); img.crossOrigin="anonymous"; img.src=src; return img; });
let currentScene = -1;
let showScene = false;

// FALLING LEAVES
const particleSources = [
  "https://i.postimg.cc/G3SY0BTf/Hojas1.png",
  "https://i.postimg.cc/c15YqKtb/Hojas2.png",
  "https://i.postimg.cc/2jXvpqLJ/Hojas3.png"
];
const particles = [], largeParticles = [];
const particleCount = 30, largeCount = 6;
let showLeaves = false;

let naturalW = 800, naturalH = 800;
let bgColor = document.getElementById('bgColor').value;

// Wait for images to load
let imagesLoaded = 0;
const allImages = [...horns, ...masks.filter(Boolean), ...hats.filter(Boolean)];
allImages.forEach(img=>{
  img.onload = () => {
    imagesLoaded++;
    if(imagesLoaded === allImages.length){
      naturalW = horns[0].naturalWidth;
      naturalH = horns[0].naturalHeight;
      const ratio = window.devicePixelRatio || 1;
      canvas.width = naturalW * ratio;
      canvas.height = naturalH * ratio;
      ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
      animate();
    }
  }
});

// PARTICLES
function initParticles(){
  particles.length=0; largeParticles.length=0;
  for(let i=0;i<particleCount;i++){
    const img=new Image(); img.crossOrigin="anonymous";
    img.src=particleSources[Math.floor(Math.random()*particleSources.length)];
    particles.push({img,x:Math.random()*naturalW,y:Math.random()*naturalH,vx:(Math.random()-0.5)*0.3,vy:0.7+Math.random()*1.2,scale:0.1+Math.random()*0.05,angle:Math.random()*2*Math.PI,vAngle:(Math.random()-0.5)*0.01,swayPhase:Math.random()*Math.PI*2,swaySpeed:0.008+Math.random()*0.012,alpha:1});
  }
  for(let i=0;i<largeCount;i++){
    const img=new Image(); img.crossOrigin="anonymous";
    img.src=particleSources[Math.floor(Math.random()*particleSources.length)];
    largeParticles.push({img,x:Math.random()*naturalW,y:Math.random()*naturalH,vx:(Math.random()-0.3)*0.2,vy:0.5+Math.random()*0.8,scale:0.18+Math.random()*0.08,angle:Math.random()*2*Math.PI,vAngle:(Math.random()-0.3)*0.007,swayPhase:Math.random()*Math.PI*2,swaySpeed:0.004+Math.random()*0.008,alpha:1});
  }
}

// RENDER
function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle=bgColor;
  ctx.fillRect(0,0,canvas.width,canvas.height);

  if(showScene && currentScene>=0 && currentScene<sceneImgs.length && sceneImgs[currentScene].complete)
    ctx.drawImage(sceneImgs[currentScene],0,0,canvas.width,canvas.height);

  if(!(showScene && currentScene===1)){
    if(bgLeaves.complete) ctx.drawImage(bgLeaves,0,0,canvas.width,canvas.height);
    if(showLeaves) drawLeaves();
  }

  const yOffset = (showScene && currentScene===1) ? 90 : 0;
  const skeletesMaskURL="https://i.postimg.cc/SsTT1FSb/Skeletes2.png";
  const skeletesActive=masks[currentMask] && masks[currentMask].src.includes(skeletesMaskURL);

  if(skeletesActive){
    ctx.save();
    ctx.shadowColor='rgba(200,150,255,0.9)';
    ctx.shadowBlur=30+Math.sin(Date.now()/400)*15;
    ctx.shadowOffsetX=0; ctx.shadowOffsetY=0;
    ctx.globalAlpha=0.8;
    ctx.drawImage(masks[currentMask],0,yOffset,canvas.width,canvas.height);
    ctx.restore();
    ctx.drawImage(masks[currentMask],0,yOffset,canvas.width,canvas.height);
  } else {
    ctx.drawImage(horns[currentHorn],0,yOffset,canvas.width,canvas.height);
    if(colorMask.complete && colorMaskColor){
      ctx.save();
      const temp=document.createElement("canvas");
      temp.width=canvas.width; temp.height=canvas.height;
      const tctx=temp.getContext("2d");
      tctx.drawImage(colorMask,0,yOffset,canvas.width,canvas.height);
      tctx.globalCompositeOperation="source-in";
      tctx.fillStyle=colorMaskColor;
      tctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(temp,0,0);
      ctx.restore();
    }
  }

  if(masks[currentMask] && !skeletesActive)
    ctx.drawImage(masks[currentMask],0,yOffset,canvas.width,canvas.height);

  if(hats[currentHat]) ctx.drawImage(hats[currentHat],0,yOffset,canvas.width,canvas.height);
}

function drawLeaves(){
  const all=[...particles,...largeParticles];
  all.forEach(p=>{
    const sway=Math.sin(p.swayPhase)*12;
    ctx.save(); ctx.globalAlpha=p.alpha;
    ctx.translate(p.x+sway,p.y);
    ctx.rotate(p.angle);
    ctx.scale(p.scale,p.scale);
    ctx.drawImage(p.img,-p.img.width/2,-p.img.height/2);
    ctx.restore();
    p.x+=p.vx+Math.sin(p.swayPhase*0.5)*0.3;
    p.y+=p.vy; p.angle+=p.vAngle; p.swayPhase+=p.swaySpeed;
    if(p.y>canvas.height){p.y=-p.img.height; p.x=Math.random()*canvas.width;}
    if(p.x>canvas.width) p.x=0; if(p.x<0) p.x=canvas.width;
  });
}

function animate(){ render(); requestAnimationFrame(animate); }

// BUTTONS
const bgBtn=document.getElementById('bgButton');
const bgColorInput=document.getElementById('bgColor');
const sceneBtn=document.getElementById('sceneBtn');
bgBtn.onclick=()=>bgColorInput.click();
bgColorInput.oninput=(e)=>{ bgColor=e.target.value; bgBtn.style.background=bgColor; bgBtn.style.color=getTextColor(bgColor); showScene=false; currentScene=-1; sceneBtn.textContent="üé¨ No Scene"; sceneBtn.style.boxShadow="none"; render(); };

const colorMaskBtn=document.getElementById('colorMaskButton');
const colorMaskInput=document.getElementById('colorMask');
colorMaskBtn.onclick=()=>colorMaskInput.click();
colorMaskInput.oninput=(e)=>{ colorMaskColor=e.target.value; colorMaskBtn.style.background=colorMaskColor; colorMaskBtn.style.color=getTextColor(colorMaskColor); render(); };

document.getElementById('randomBtn').onclick=()=>{
  currentHorn = Math.floor(Math.random()*horns.length);
  currentMask=Math.floor(Math.random()*masks.length);
  currentHat=Math.floor(Math.random()*hats.length);
  const hueMask=Math.floor(Math.random()*360);
  colorMaskColor=`hsl(${hueMask},60%,60%)`;
  colorMaskBtn.style.background=colorMaskColor;
  render();
};

document.getElementById('leavesBtn').onclick=()=>{showLeaves=!showLeaves;if(showLeaves)initParticles();};

sceneBtn.onclick=()=>{
  currentScene=(currentScene+1)%(sceneImgs.length+1);
  if(currentScene===sceneImgs.length){ showScene=false; sceneBtn.textContent="üé¨ No Scene"; sceneBtn.style.boxShadow="none"; }
  else { showScene=true; sceneBtn.textContent=`üé¨ Scene ${currentScene+1}`; sceneBtn.style.boxShadow=(currentScene===0?"0 0 12px 4px gold":"0 0 12px 4px purple"); }
  render();
};

document.getElementById('save').onclick=()=>{ const link=document.createElement('a'); link.download='BillyFall.png'; link.href=canvas.toDataURL(); link.click(); };

// SECONDARY CONTROLS
document.getElementById('hornBtn').onclick = () => { currentHorn = (currentHorn + 1) % horns.length; render(); };
document.getElementById('hatBtn').onclick = () => { currentHat = (currentHat + 1) % hats.length; render(); };
document.getElementById('glassesBtn').onclick = () => { let idx = currentMask; do { idx = (idx + 1) % masks.length; } while(!masks[idx]); currentMask = idx; render(); };

function getTextColor(hex){ const c=hex.substring(1); const rgb=parseInt(c,16); const r=(rgb>>16)&255,g=(rgb>>8)&255,b=rgb&255; const lum=0.299*r+0.587*g+0.114*b; return lum<128?'white':'black'; }
</script>
</body>
</html>
