<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Billy Fall Switcher + Mask + Color Mask + Leaves + Dual Scenes + Hats</title>
<style>
body {
  background: #111;
  display: flex;
  flex-direction: column;
  margin: 0;
  font-family: sans-serif;
  height: 100vh;
}

#container {
  background: #fff;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  width: 90vmin;
  height: 90vmin; /* square */
  overflow: hidden;
  margin: 0 auto;
}

canvas {
  display: block;
  width: 100%;
  height: 100%;
  border-radius: 10px;
}

#randomBtn, #leavesBtn {
  position: absolute;
  top: 10px;
  padding: 8px 12px;
  border-radius: 6px;
  border: none;
  font-weight: bold;
  background: white;
  cursor: pointer;
  z-index: 10;
}
#randomBtn { right: 10px; }
#leavesBtn { left: 10px; box-shadow: 0 0 10px rgba(255,255,255,0.8); }

/* Controls container */
.controls {
  display: flex;
  flex-wrap: nowrap;
  width: 90vmin;
  margin: 10px auto 0 auto;
  gap: 6px;
  justify-content: space-between;
}

/* All buttons */
.controls button,
.controls input[type="color"] {
  padding: 10px;
  font-weight: bold;
  border-radius: 6px;
  border: none;
  background: white;
  color: black;
  cursor: pointer;
  text-align: center;
  flex: 1; /* fill equally on desktop */
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Save button special styling */
#save {
  background: green;
  color: white;
  flex: 1; /* desktop equal height */
}

/* MOBILE FIX */
@media(max-width:768px){
  #container {
    width: 100vw;
    height: 100vw; /* always square */
  }

  .controls {
    flex-direction: column;
    width: 95%; /* space from edges */
    height: calc(100vh - 100vw); /* remaining vertical space */
    margin: 0 auto;
    padding: 5px;
    box-sizing: border-box;
    justify-content: space-between;
  }

  /* Calculate each row height to fit all buttons without scrolling */
  .controls button,
  .controls input[type="color"] {
    font-size: 1em;
    border-radius: 8px;
    flex: none;
  }

  /* Top row: Background + Billie Color side by side */
  .controls .top-row {
    display: flex;
    gap: 5px;
    height: calc((100% - 10px*3)/4); /* 4 rows, 3 gaps */
  }
  .controls .top-row button,
  .controls .top-row input[type="color"] {
    flex: 1;
    height: 100%;
  }

  /* Scene button row */
  #sceneBtn {
    height: calc((100% - 10px*3)/4);
    margin: 5px 0;
  }

  /* Middle row: Horn + Hat + Glasses horizontal */
  .controls .middle-row {
    display: flex;
    gap: 5px;
    height: calc((100% - 10px*3)/4);
  }
  .controls .middle-row button {
    flex: 1;
    height: 100%;
  }

  /* Save button full width row */
  #save {
    height: calc((100% - 10px*3)/4);
    margin-top: 5px;
  }
}
</style>

<div id="container">
  <canvas id="canvas"></canvas>
  <button id="randomBtn">üé≤ Random</button>
  <button id="leavesBtn">üçÇ Leaves</button>
</div>

<div class="controls">
  <!-- Top row for Background + Billie Color -->
  <div class="top-row">
    <button id="bgButton">Background</button>
    <input type="color" id="bgColor" value="#ffffff" style="display:none;">
    <button id="colorMaskButton">Billie Color</button>
    <input type="color" id="colorMask" value="#ffcc99" style="display:none;">
  </div>

  <!-- Scene button -->
  <button id="sceneBtn">üé¨ Scene</button>

  <!-- Middle row Horn/Hat/Glasses -->
  <div class="middle-row">
    <button id="swapHorn">Horn</button>
    <button id="swapHat">Hat</button>
    <button id="swapMask">Glasses</button>
  </div>

  <!-- Save button -->
  <button id="save">Save PNG</button>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

// BASES
const baseSources = [
  "https://i.postimg.cc/KYTmT02j/BillyFallBase3.png",
  "https://i.postimg.cc/fLKn7Fq6/Horn2.png"
];
const bases = [];
let currentBase = 0;

// MASKS
const maskSources = [
  null,
  "https://i.postimg.cc/5NWYLjj2/Mask-Pumpking3.png",
  "https://i.postimg.cc/gJDLjj0H/Glasses1.png",
  "https://i.postimg.cc/ry1nS0gY/Skull-Glasses2.png",
  "https://i.postimg.cc/0yKP50d0/Ba-Tglasses.png",
  "https://i.postimg.cc/SsTT1FSb/Skeletes2.png",
  "https://i.postimg.cc/j5n4jXCh/SUnglasses-SK-l.png",
  "https://i.postimg.cc/ZqbygLrd/lentes5.png",
  "https://i.postimg.cc/W4dkmwgz/Glass-Blood.png",
  "https://i.postimg.cc/8cj9N36k/Glass-Cnagel.png"
];
const masks = [];
let currentMask = 0;

// HATS
const hatSources = [
  null,
  "https://i.postimg.cc/636Tj5xG/Hattes2sombras.png",
  "https://i.postimg.cc/yN3z7Mh5/Hateer23.png"
];
const hats = [];
let currentHat = 0;

// COLOR MASK
const colorMaskSrc = "https://i.postimg.cc/0NzkgQgy/Mask40.png";
const colorMask = new Image();
colorMask.crossOrigin = "anonymous";
colorMask.src = colorMaskSrc;
let colorMaskColor = null;

// STATIC LEAVES
const bgLeaves = new Image();
bgLeaves.crossOrigin = "anonymous";
bgLeaves.src = "https://i.postimg.cc/2jqF2p04/Leaves22.png";

// SCENES
const sceneSources = [
  "https://i.postimg.cc/132fCVjd/Chat-GPT-Image-8-oct-2025-16-45-48.png",
  "https://i.postimg.cc/XNTpMmZg/Noche2.png"
];
const sceneImgs = sceneSources.map(src => { const img = new Image(); img.crossOrigin="anonymous"; img.src=src; return img; });
let currentScene = sceneImgs.length;
let showScene = false;

// FALLING LEAVES
const particleSources = [
  "https://i.postimg.cc/G3SY0BTf/Hojas1.png",
  "https://i.postimg.cc/c15YqKtb/Hojas2.png",
  "https://i.postimg.cc/2jXvpqLJ/Hojas3.png"
];
const particles = [], largeParticles = [];
const particleCount = 30, largeCount = 6;
let showLeaves = false;

let naturalW = 800, naturalH = 800;
let bgColor = document.getElementById('bgColor').value;

// Preload
baseSources.forEach(src => { const img=new Image(); img.crossOrigin="anonymous"; img.src=src; bases.push(img); });
maskSources.forEach(src => { if(src){ const img=new Image(); img.crossOrigin="anonymous"; img.src=src; masks.push(img); } else masks.push(null); });
hatSources.forEach(src => { if(src){ const img=new Image(); img.crossOrigin="anonymous"; img.src=src; hats.push(img); } else hats.push(null); });

// Particles
function initParticles(){
  particles.length=0; largeParticles.length=0;
  for(let i=0;i<particleCount;i++){
    const img=new Image(); img.crossOrigin="anonymous";
    img.src=particleSources[Math.floor(Math.random()*particleSources.length)];
    particles.push({img,x:Math.random()*naturalW,y:Math.random()*naturalH,vx:(Math.random()-0.5)*0.3,vy:0.7+Math.random()*1.2,scale:0.1+Math.random()*0.05,angle:Math.random()*2*Math.PI,vAngle:(Math.random()-0.5)*0.01,swayPhase:Math.random()*Math.PI*2,swaySpeed:0.008+Math.random()*0.012,alpha:1});
  }
  for(let i=0;i<largeCount;i++){
    const img=new Image(); img.crossOrigin="anonymous";
    img.src=particleSources[Math.floor(Math.random()*particleSources.length)];
    largeParticles.push({img,x:Math.random()*naturalW,y:Math.random()*naturalH,vx:(Math.random()-0.3)*0.2,vy:0.5+Math.random()*0.8,scale:0.18+Math.random()*0.08,angle:Math.random()*2*Math.PI,vAngle:(Math.random()-0.3)*0.007,swayPhase:Math.random()*Math.PI*2,swaySpeed:0.004+Math.random()*0.008,alpha:1});
  }
}

// RENDER
function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle=bgColor;
  ctx.fillRect(0,0,naturalW,naturalH);

  if(showScene && currentScene<sceneImgs.length && sceneImgs[currentScene].complete)
    ctx.drawImage(sceneImgs[currentScene],0,0,naturalW,naturalH);

  if(!(showScene && currentScene===1)){
    if(bgLeaves.complete) ctx.drawImage(bgLeaves,0,0,naturalW,naturalH);
    if(showLeaves) drawLeaves();
  }

  const yOffset=(showScene && currentScene===1)?90:0;

  const skeletesMaskURL="https://i.postimg.cc/SsTT1FSb/Skeletes2.png";
  const skeletesActive=masks[currentMask] && masks[currentMask].src.includes(skeletesMaskURL);

  if(skeletesActive){
    ctx.save();
    ctx.shadowColor='rgba(200,150,255,0.9)';
    ctx.shadowBlur=30+Math.sin(Date.now()/400)*15;
    ctx.shadowOffsetX=0; ctx.shadowOffsetY=0;
    ctx.globalAlpha=0.8;
    ctx.drawImage(masks[currentMask],0,yOffset,naturalW,naturalH);
    ctx.restore();
    ctx.drawImage(masks[currentMask],0,yOffset,naturalW,naturalH);
  } else {
    ctx.drawImage(bases[currentBase],0,yOffset,naturalW,naturalH);
    if(colorMask.complete && colorMaskColor){
      ctx.save();
      const temp=document.createElement("canvas");
      temp.width=naturalW; temp.height=naturalH;
      const tctx=temp.getContext("2d");
      tctx.drawImage(colorMask,0,yOffset,naturalW,naturalH);
      tctx.globalCompositeOperation="source-in";
      tctx.fillStyle=colorMaskColor;
      tctx.fillRect(0,0,naturalW,naturalH);
      ctx.drawImage(temp,0,0);
      ctx.restore();
    }
  }

  if(masks[currentMask] && !skeletesActive)
    ctx.drawImage(masks[currentMask],0,yOffset,naturalW,naturalH);

  if(hats[currentHat]) ctx.drawImage(hats[currentHat],0,yOffset,naturalW,naturalH);
}

function drawLeaves(){
  const all=[...particles,...largeParticles];
  all.forEach(p=>{
    const sway=Math.sin(p.swayPhase)*12;
    ctx.save(); ctx.globalAlpha=p.alpha;
    ctx.translate(p.x+sway,p.y);
    ctx.rotate(p.angle);
    ctx.scale(p.scale,p.scale);
    ctx.drawImage(p.img,-p.img.width/2,-p.img.height/2);
    ctx.restore();
    p.x+=p.vx+Math.sin(p.swayPhase*0.5)*0.3;
    p.y+=p.vy; p.angle+=p.vAngle; p.swayPhase+=p.swaySpeed;
    if(p.y>naturalH){p.y=-p.img.height; p.x=Math.random()*naturalW;}
    if(p.x>naturalW) p.x=0; if(p.x<0) p.x=naturalW;
  });
}

function animate(){ render(); requestAnimationFrame(animate); }

// BUTTONS
document.getElementById('bgButton').onclick=()=>document.getElementById('bgColor').click();
document.getElementById('bgColor').oninput=(e)=>{
  bgColor=e.target.value;
  document.getElementById('bgButton').style.background=bgColor;
  document.getElementById('bgButton').style.color=getTextColor(bgColor);
  showScene=false; currentScene=sceneImgs.length;
  document.getElementById('sceneBtn').textContent="üé¨ No Scene";
  document.getElementById('sceneBtn').style.boxShadow="none";
  render();
};

document.getElementById('colorMaskButton').onclick=()=>document.getElementById('colorMask').click();
document.getElementById('colorMask').oninput=(e)=>{ 
  colorMaskColor=e.target.value; 
  const btn=document.getElementById('colorMaskButton'); 
  btn.style.background=colorMaskColor; 
  btn.style.color=getTextColor(colorMaskColor); 
  render();
};

document.getElementById('sceneBtn').onclick=()=>{
  currentScene=(currentScene+1)%(sceneImgs.length+1);
  if(currentScene===sceneImgs.length){
    showScene=false; document.getElementById('sceneBtn').textContent="üé¨ No Scene"; document.getElementById('sceneBtn').style.boxShadow="none";
  } else {
    showScene=true; document.getElementById('sceneBtn').textContent=`üé¨ Scene ${currentScene+1}`;
    document.getElementById('sceneBtn').style.boxShadow=(currentScene===0?"0 0 12px 4px gold":"0 0 12px 4px purple");
  }
  render();
};

document.getElementById('save').onclick=()=>{
  const link=document.createElement('a');
  link.download='BillyFall.png';
  link.href=canvas.toDataURL();
  link.click();
};

document.getElementById('randomBtn').onclick=()=>{
  currentBase=Math.floor(Math.random()*bases.length);
  currentMask=Math.floor(Math.random()*masks.length);
  currentHat=Math.floor(Math.random()*hats.length);
  const hueMask=Math.floor(Math.random()*360);
  colorMaskColor=`hsl(${hueMask},60%,60%)`;
  document.getElementById('colorMaskButton').style.background=colorMaskColor;
  render();
};

document.getElementById('leavesBtn').onclick=()=>{showLeaves=!showLeaves;if(showLeaves)initParticles();};

// INDIVIDUAL SWAP BUTTONS
document.getElementById('swapHorn').onclick=()=>{ currentBase=(currentBase+1)%bases.length; render(); };
document.getElementById('swapHat').onclick=()=>{ currentHat=(currentHat+1)%hats.length; render(); };
document.getElementById('swapMask').onclick=()=>{ currentMask=(currentMask+1)%masks.length; render(); };

function getTextColor(hex){
  const c=hex.substring(1);
  const rgb=parseInt(c,16);
  const r=(rgb>>16)&255,g=(rgb>>8)&255,b=rgb&255;
  const lum=0.299*r+0.587*g+0.114*b;
  return lum<128?'white':'black';
}

// INIT
bases[0].onload=()=>{
  naturalW=bases[0].naturalWidth;
  naturalH=bases[0].naturalHeight;
  const ratio=window.devicePixelRatio||1;
  canvas.width=naturalW*ratio;
  canvas.height=naturalH*ratio;
  ctx.setTransform(ratio,0,0,ratio,0,0);
  animate();
};
</script>
</body>
</html>
